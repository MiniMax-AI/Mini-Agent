name: GitHub Configuration Test

on:
  push:
    branches: [feature/multi-agent-orchestration]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: true
        default: 'quick'
        type: choice
        options:
          - quick
          - full

jobs:
  test-github-config:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/feature/multi-agent-orchestration'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests httpx

      - name: Test GitHub API Connection
        run: |
          python3 -c "
          import os
          import urllib.request
          import json

          print('='*60)
          print('ğŸ§ª æµ‹è¯• 1: GitHub API è¿æ¥')
          print('='*60)

          token = os.environ.get('GITHUB_TOKEN')
          if not token:
              print('âŒ GITHUB_TOKEN æœªè®¾ç½®')
              exit(1)

          print(f'âœ… GITHUB_TOKEN å·²è®¾ç½® (å‰ç¼€: {token[:7]}...)')

          try:
              url = 'https://api.github.com/user'
              request = urllib.request.Request(url)
              request.add_header('Authorization', f'Bearer {token}')
              request.add_header('Accept', 'application/vnd.github.v3+json')

              with urllib.request.urlopen(request, timeout=10) as response:
                  data = json.loads(response.read().decode())
                  print(f'âœ… API è¿æ¥æˆåŠŸ!')
                  print(f'   ç”¨æˆ·å: {data.get(\"login\")}')
                  print(f'   å…¬å¼€ä»“åº“: {data.get(\"public_repos\")}')
                  print(f'   ç§æœ‰ä»“åº“: {data.get(\"total_private_repos\", 0)}')
          except Exception as e:
              print(f'âŒ API è¿æ¥å¤±è´¥: {e}')
              exit(1)
          "

      - name: Test Repository Access
        run: |
          python3 -c "
          import os
          import urllib.request
          import json

          print('='*60)
          print('ğŸ§ª æµ‹è¯• 2: ä»“åº“è®¿é—®æƒé™')
          print('='*60)

          token = os.environ.get('GITHUB_TOKEN')

          repos_to_test = [
              ('zhaofei0923/Mini-Agent', 'ç”¨æˆ·ä»“åº“'),
              ('MiniMax-AI/Mini-Agent', 'ä¸Šæ¸¸ä»“åº“'),
          ]

          for repo, name in repos_to_test:
              try:
                  url = f'https://api.github.com/repos/{repo}'
                  request = urllib.request.Request(url)
                  request.add_header('Authorization', f'Bearer {token}')
                  request.add_header('Accept', 'application/vnd.github.v3+json')

                  with urllib.request.urlopen(request, timeout=10) as response:
                      data = json.loads(response.read().decode())
                      print(f'âœ… {name} è®¿é—®æˆåŠŸ')
                      print(f'   ä»“åº“: {data[\"full_name\"]}')
                      print(f'   Stars: {data[\"stargazers_count\"]}')
              except Exception as e:
                  print(f'âŒ {name} è®¿é—®å¤±è´¥: {e}')
                  exit(1)
          "

      - name: Test GitHub Operations
        if: github.event.inputs.test_mode == 'full'
        run: |
          python3 -c "
          import os
          import urllib.request
          import json
          from datetime import datetime

          print('='*60)
          print('ğŸ§ª æµ‹è¯• 3: GitHub æ“ä½œåŠŸèƒ½')
          print('='*60)

          token = os.environ.get('GITHUB_TOKEN')

          # æµ‹è¯• 1: åˆ—å‡ºä»“åº“
          print('\\nğŸ“‹ æµ‹è¯•åˆ—å‡ºç”¨æˆ·ä»“åº“...')
          url = 'https://api.github.com/user/repos?per_page=5&sort=updated'
          request = urllib.request.Request(url)
          request.add_header('Authorization', f'Bearer {token}')
          request.add_header('Accept', 'application/vnd.github.v3+json')

          with urllib.request.urlopen(request, timeout=10) as response:
              repos = json.loads(response.read().decode())
              print(f'âœ… æˆåŠŸåˆ—å‡º {len(repos)} ä¸ªä»“åº“')
              for repo in repos[:3]:
                  print(f'   - {repo[\"full_name\"]}')

          # æµ‹è¯• 2: åˆ—å‡º Issues
          print('\\nğŸ“ æµ‹è¯•åˆ—å‡º Issues...')
          url = 'https://api.github.com/repos/zhaofei0923/Mini-Agent/issues?state=all&per_page=5'
          request = urllib.request.Request(url)
          request.add_header('Authorization', f'Bearer {token}')
          request.add_header('Accept', 'application/vnd.github.v3+json')

          with urllib.request.urlopen(request, timeout=10) as response:
              issues = json.loads(response.read().decode())
              print(f'âœ… æˆåŠŸåˆ—å‡º {len(issues)} ä¸ª Issues')

          # æµ‹è¯• 3: åˆ—å‡º Pull Requests
          print('\\nğŸ”€ æµ‹è¯•åˆ—å‡º Pull Requests...')
          url = 'https://api.github.com/repos/zhaofei0923/Mini-Agent/pulls?state=all&per_page=5'
          request = urllib.request.Request(url)
          request.add_header('Authorization', f'Bearer {token}')
          request.add_header('Accept', 'application/vnd.github.v3+json')

          with urllib.request.urlopen(request, timeout=10) as response:
              prs = json.loads(response.read().decode())
              print(f'âœ… æˆåŠŸåˆ—å‡º {len(prs)} ä¸ª Pull Requests')
              if prs:
                  print(f'   æœ€æ–° PR: #{prs[0][\"number\"]} - {prs[0][\"title\"]}')

          # æµ‹è¯• 4: è·å– Actions å·¥ä½œæµ
          print('\\nâš™ï¸ æµ‹è¯•è·å– Actions å·¥ä½œæµ...')
          url = 'https://api.github.com/repos/zhaofei0923/Mini-Agent/actions/runs?per_page=3'
          request = urllib.request.Request(url)
          request.add_header('Authorization', f'Bearer {token}')
          request.add_header('Accept', 'application/vnd.github.v3+json')

          with urllib.request.urlopen(request, timeout=10) as response:
              runs = json.loads(response.read().decode())
              print(f'âœ… æˆåŠŸè·å–å·¥ä½œæµè¿è¡Œè®°å½•')
              if runs.get('workflow_runs'):
                  latest = runs['workflow_runs'][0]
                  print(f'   æœ€æ–°è¿è¡Œ: {latest[\"name\"]} - {latest[\"status\"]}')

          print('\\nâœ… æ‰€æœ‰ GitHub æ“ä½œæµ‹è¯•é€šè¿‡!')
          "

      - name: Test MCP Configuration
        run: |
          python3 -c "
          import json
          from pathlib import Path

          print('='*60)
          print('ğŸ§ª æµ‹è¯• 4: MCP é…ç½®éªŒè¯')
          print('='*60)

          mcp_path = Path('mini_agent/config/mcp.json')

          if not mcp_path.exists():
              print('âŒ MCP é…ç½®æ–‡ä»¶ä¸å­˜åœ¨')
              exit(1)

          with open(mcp_path, 'r', encoding='utf-8') as f:
              mcp_config = json.load(f)

          print('âœ… MCP é…ç½®æ–‡ä»¶è¯»å–æˆåŠŸ')

          if 'mcpServers' not in mcp_config:
              print('âŒ mcpServers é…ç½®ä¸å­˜åœ¨')
              exit(1)

          servers = mcp_config['mcpServers']

          if 'github' not in servers:
              print('âŒ GitHub MCP æœåŠ¡å™¨æœªé…ç½®')
              exit(1)

          github_config = servers['github']

          print('âœ… GitHub MCP æœåŠ¡å™¨å·²é…ç½®')

          # æ£€æŸ¥å¿…éœ€å­—æ®µ
          required_fields = ['command', 'disabled', 'env']
          for field in required_fields:
              if field not in github_config:
                  print(f'âŒ GitHub MCP ç¼ºå°‘å¿…è¦é…ç½®: {field}')
                  exit(1)

          if github_config.get('disabled', False):
              print('âš ï¸ GitHub MCP å·²ç¦ç”¨')
              exit(1)
          else:
              print('âœ… GitHub MCP å·²å¯ç”¨')

          print('\\nâœ… MCP é…ç½®éªŒè¯é€šè¿‡!')
          "

      - name: Summary
        run: |
          echo "============================================================"
          echo "ğŸ‰ GitHub é…ç½®æµ‹è¯•å®Œæˆ!"
          echo "============================================================"
          echo ""
          echo "âœ… GitHub Token å·²æ­£ç¡®é…ç½®"
          echo "âœ… API è¿æ¥æ­£å¸¸"
          echo "âœ… ä»“åº“è®¿é—®æƒé™æ­£å¸¸"
          echo "âœ… MCP é…ç½®æ­£ç¡®"
          echo ""
          echo "ğŸ’¡ agent ç°åœ¨å¯ä»¥:"
          echo "   - æ“ä½œ GitHub ä»“åº“ (åˆ›å»º PRã€æäº¤ä»£ç ç­‰)"
          echo "   - ä½¿ç”¨ GitHub MCP å·¥å…·"
          echo "   - è§¦å‘å’Œç®¡ç† GitHub Actions"
